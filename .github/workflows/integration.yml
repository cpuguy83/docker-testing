name: Integration
on:
  workflow_dispatch:
    inputs:
      testFilter:
        description: Run a subset of tests(TEST_FILTER)
        default: ''
      os:
        required: true
        description: OS to run tests on
        default: ubuntu-18.04

jobs:
  integration-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["${{ github.event.inputs.os }}"]
        engine: ["20.10", "master"]
        containerd: ["1.4", "1.5"]
        runc: ["1.0", "master"]
        cli: ["20.10", "19.03", "master", ""]
        include:
          - cli: "20.10"
            suite: DockerDaemonSuite|DockerExternalVolumeSuite|DockerPluginSuite|DockerSuite|DockerSwarmSuite
          - cli: "20.10"
            suite: DockerHubPullSuite|DockerNetworkSuite|DockerRegistryAuthHtpasswdSuite|DockerRegistryAuthTokenSuite|DockerRegistrySuite|DockerSchema1RegistrySuite
          - cli: "19.03"
            suite: DockerDaemonSuite|DockerExternalVolumeSuite|DockerPluginSuite|DockerSuite|DockerSwarmSuite
          - cli: "19.03"
            suite: DockerHubPullSuite|DockerNetworkSuite|DockerRegistryAuthHtpasswdSuite|DockerRegistryAuthTokenSuite|DockerRegistrySuite|DockerSchema1RegistrySuite
    name: os=${{ matrix.os }} engine=${{ matrix.engine }} containerd=${{ matrix.containerd }} cli=${{ matrix.cli }} runc=${{ matrix.runc }} ${{matrix.suite}}
    steps:
    - uses: actions/checkout@v2
    - uses: actions/checkout@v2
      if: ${{ matrix.version == 'master' }} && ${{ matrix.project == 'engine' }}
      with:
        repository: moby/moby
        fetch-depth: 1
        path: engine-src
    - uses: actions/checkout@v2
      if: ${{ matrix.version == 'master' }} && ${{ matrix.project == 'cli' }}
      with:
        repository: docker/cli
        fetch-depth: 1
        path: cli-src
    - uses: actions/checkout@v2
      if: ${{ matrix.version == 'master' }} && ${{ matrix.project == 'runc' }}
      with:
        repository: opencontainers/runc
        fetch-depth: 1
        path: runc-src
    - name: Login to GHCR
      run: echo ${{ secrets.CR_PAT }} | docker login https://ghcr.io -u ${{ github.actor }} --password-stdin
    - name: Build all the things
      env:
        DISTRO: ${{matrix.os}}
        ENGINE_VERSION: ${{matrix.engine}}
        CLI_VERSION: ${{matrix.cli}}
        RUNC_VERSION: ${{matrix.runc}}
        CONTAINERD_VERSION: ${{matrix.containerd}}
      run: |
        set -e -x

        engine_tag="engine-$(echo ${{matrix.os}}${{matrix.engine}} | sha256sum | awk '{{ print $1 }}')"
        cli_tag="cli-$(echo ${{matrix.os}}${{matrix.cli}} | sha256sum | awk '{{ print $1 }}')"
        containerd_tag="containerd-$(echo ${{matrix.os}}${{matrix.containerd}} | sha256sum | awk '{{ print $1 }}')"
        runc_tag="runc-$(echo ${{matrix.os}}${{matrix.runc}} | sha256sum | awk '{{ print $1 }}')"

        export ENGINE_CACHE_FROM="ghcr.io/${{ github.repository }}/cache:${engine_tag}"
        export CLI_CACHE_FROM="ghcr.io/${{ github.repository }}/cache:${cli_tag}"
        export CONTAINERD_CACHE_FROM="ghcr.io/${{ github.repository }}/cache:${containerd_tag}"
        export RUNC_CACHE_FROM="ghcr.io/${{ github.repository }}/cache:${runc_tag}"

        if [ -z "CLI_VERSION" ]; then
          # Tests need the CLI even though we will not be using the CLI suite here
          export CLI_VERSION="20.10"
        fi

        if [ "${ENGINE_VERSION}" = "master" ]; then
          export ENGINE_COMMIT="$(git -C ./engine-src rev-parse HEAD)"
        fi
        if [ "${CLI_VERSION}" = "master" ]; then
          export CLI_COMMIT="$(git -C ./cli-src rev-parse HEAD)"
        fi
        if [ "${RUNC_VERSION}" = "master" ]; then
          export RUNC_COMMIT="$(git -C ./runc-src rev-parse HEAD)"
        fi

        make -j 4 engine containerd runc cli
    - name: Test
      env:
        DOCKER_INTEGRATION_TESTS_VERIFIED: true
        APT_MIRROR: http://azure.archive.ubuntu.com/ubuntu
        CACHE_FROM: ghcr.io/${{github.repository}}/${{matrix.os}}:latest
        TEST_FILTER: ${{ github.event.inputs.testFilter }}
      run: |
        if [ -z "${{matrix.cli}}" ]; then
          export TEST_SKIP_INTEGRATION_CLI=1
        else
          export TEST_SKIP_INTEGRATION=1
          export TESTFLAGS="-test.run Test(${{matrix.suite}})"
        fi

        make test DISTRO=${{matrix.os}}
    - name: Cleanup
      if: failure() || cancelled()
      run: |
        sudo chown -R $(id -u):$(id -g) out
        for i in out/tests/test-integration/*; do
          [ -d "${i}" ] || continue
          sudo find  "${i}" -maxdepth 2 -name root | tee | sudo xargs rm -rf
        done
    - name: Generate artifact name
      id: generate-artifact-name
      if: always()
      run: |
        echo "::set-output name=name::os=${{ matrix.os }} engine=${{ matrix.engine }} containerd=${{ matrix.containerd }} cli=${{ matrix.cli }} runc=${{ matrix.runc }} $(echo '${{matrix.suite}}' | sed 's,|,_,g')"
    - uses: actions/upload-artifact@v2
      if: always()
      with:
        name: ${{ steps.generate-artifact-name.outputs.name }}
        path: |
          !out/tests/test-integration/*/d*/root
          !out/tests/test-integration/*/d*/*.sock
          !out/tests/test-integration/*/*.sock
          out/tests/**
        retention-days: 10
  publish:
    runs-on: ubuntu-20.04
    name: Publish Results
    needs: integration-linux
    if: always()
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v2
      with:
        path: artifacts
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v1
      if: always()
      with:
        files: artifacts/**/test-integration/*.xml
        check_name: Test Results